{{ if .Store.Get "hasMermaid" }}
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
    const isDark = () => document.documentElement.classList.contains('dark')
      || window.matchMedia('(prefers-color-scheme: dark)').matches;

    function initMermaid() {
      mermaid.initialize({ startOnLoad: true, theme: isDark() ? 'dark' : 'default' });
      // 重新渲染（可选）：document.querySelectorAll('.mermaid').forEach(el => el.removeAttribute('data-processed'));
      // mermaid.run();  // 需要时再启用
    }

    initMermaid();
    // 常见的主题切换：PaperMod 会在 html 上加/去掉 .dark，可用 MutationObserver 监听
    const observer = new MutationObserver(initMermaid);
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
  </script>
{{ end }}

